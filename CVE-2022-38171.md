# Xpdf JBIG2 integer overflow (CVE-2022-38171) and lineage

Released in September 2021, [CVE-2021-30860](https://www.cve.org/CVERecord?id=CVE-2022-30860) fixes an Xpdf integer (then heap) overflow in various Apple operating systems, documented by Apple as affecting CoreGraphics (e.g., [https://support.apple.com/en-us/HT212807](https://support.apple.com/en-us/HT212807)).

Per Google Project Zero's [December 2021 write up](https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html) of FORCEDENTRY:
> Most of the CoreGraphics PDF decoder appears to be Apple proprietary code, but the JBIG2 implementation is from Xpdf, the source code for which is freely available.

[CVE-2022-38171](https://www.cve.org/CVERecord?id=CVE-2022-38171) is the ~upstream instance of this vulnerability in Xpdf, fixed in April 2022 in Xpdf 4.04.

Poppler forked an older version of Xpdf 2005 and may backports some changes.
> [Poppler](https://poppler.freedesktop.org/) is a PDF rendering library based on the xpdf-3.0 code base.

[Fixed](https://gitlab.freedesktop.org/poppler/poppler/-/merge_requests/1261/diffs?commit_id=27354e9d9696ee2bc063910a6c9a6b27c5184a52) in Poppler [22.09.0](https://gitlab.freedesktop.org/poppler/poppler/-/commit/4602cac96104b74037862e223bb774be26bfd67c) as [CVE-2022-38784](https://www.cve.org/CVERecord?id=CVE-2022-38784).

Plenty of distros include Poppler, Xpdf, and downstream packages. [Notified](https://www.openwall.com/lists/oss-security/2022/09/02/11) oss-security list on 2022-09-02.

This [exploit](https://github.com/jeffssh/CVE-2021-30860) crashes Xpdf (<4.04), Poppler (<22.09.0), and other downstream software. Exploiting the vulnerability to run arbitrary code is context dependent. The Apple instance of the vulnerability (CVE-2021-30860) is used as one link in the FORCEDENTRY exploit chain, to create a weird machine used to set up the next (IMTranscoderAgent) sandbox escape.

Observations:
- The lack of sufficient CVE IDs and other documentation caused a lot of downstream Xpdf users to not notice the vulnerability or the fix.
- CVE IDs lack a formal ability to relate to each other (and to other vulnerability identifiers), see https://github.com/CVEProject/Board-Discussions/issues/10.

```shell
#
# Fix for CVE-2022-38171 in Xpdf 4.04
#
cd $(mktemp -d)
wget https://dl.xpdfreader.com/xpdf-4.04.tar.gz # this will become https://dl.xpdfreader.com/old/xpdf-4.04.tar.gz
wget https://dl.xpdfreader.com/old/xpdf-4.03.tar.gz
for file in $(ls xpdf*.tar.gz); do tar xzf $file; done

diff -u xpdf-4.03/CHANGES xpdf-4.04/CHANGES | grep JBIG2
```

```diff
+ # Fixed an integer overflow security hole in the JBIG2 decoder.
```

```shell
diff -u xpdf-4.03/xpdf/JBIG2Stream.cc xpdf-4.04/xpdf/JBIG2Stream.cc
```

```diff
<snip>
@@ -2042,7 +2057,14 @@
   for (i = 0; i < nRefSegs; ++i) {
     if ((seg = findSegment(refSegs[i]))) {
       if (seg->getType() == jbig2SegSymbolDict) {
-	numSyms += ((JBIG2SymbolDict *)seg)->getSize();
+	Guint segSize = ((JBIG2SymbolDict *)seg)->getSize();
+	if (segSize > INT_MAX || numSyms > INT_MAX - segSize) {
+	  error(errSyntaxError, getPos(),
+		"Too many symbols in JBIG2 text region");
+	  delete codeTables;
+	  return;
+	}
+	numSyms += segSize;
       } else if (seg->getType() == jbig2SegCodeTable) {
 	codeTables->append(seg);
       }
<snip>
```

Or, see this [diff](https://github.com/zmanion/Xpdf/compare/4.03...4.04#diff-a319aeb36a561c1d57b3ecc78f541c4d4ca29dcbf85621f5193f3062df7a88a9R2057).
