# Summary
> [!Warning]
> Work in progress, not well tested, may hit on false positives or false negatives, may break functionality if used for blocking, use at your own risk, feedback welcome.

# Theory 1 '/mifs/aad/**'

Based on the Ivanti RPMs, it appears that the vulnerability (or at least a significant part of it) is due to all URL paths under `/mifs/aad` being permitted without authentication. Some sub-paths may have required authentication, some may legitimately not requrie authentication, but some (e.g., `/mifs/aad/*/api/v2/*`) allowed attackers to bypass authentication and perform sensitive operations (like accessing other users' information, creating EPMM administrative accounts).

```diff
+ https://epmm.example.com/mifs/aad                  # allowed with no auth
+ https://epmm.example.com/mifs/aad/intune_response  # allowed with no auth

- https://epmm.example.com/mifs/aad/**               # now requires auth, was previously vulnerable
```

`ivanti-security-update-1.0.0-1.noarch.rpm` has postinstall scripts that modify Apache Tomcat and httpd configuration files:

```diff
- <sec:http pattern="/aad/**" security="none" create-session="stateless"/>

+ <sec:http pattern="/aad" security="none" create-session="stateless"/>
+ <sec:http pattern="/aad/intune_response" security="none" create-session="stateless"/>
```

```diff
+ # Whitelist specific aad URI paths
+     RewriteCond         %{REQUEST_URI} ^/mifs/aad/
+     RewriteRule         !(/mifs/aad|/mifs/aad/intune_response)$ - [F]
```

## nuclei

TBD

## YARA

TBD

## Basic regex

These paths could be vulnerable, should (all? mostly?) require authentication:

`/https?:\/\/+[\w\.-]+(.*(?=\/+aad\/+)\/+aad\/+.*)/i`

Allowed with no authentication:

`/https?:\/\/+[\w\.-]+(.*(?=\/+aad)\/+aad)$/i`

Allowed with no authentication:

`/https?:\/\/+[\w\.-]+(.*(?=\/+aad)\/+aad\/intune_response)$/i`

# Theory 2 '/mifs' + '/api/v2/'

> [!WARNING]
> Based on the Ivanti RPMs this theory seems to be at least partially incorrect.

Not vulnerable, authentication is checked:

`https://epmm.example.com/api/v2/`

Vulnerable, authenticaiton is bypassed:

`https://epmm.example.com/mifs/*/api/v2/`

Is `/mifs/` required?

Is any specific URL path required?

```
https://epmm.example.com/mifs/*/api/v2/
                         ^^^^^^^
                      what goes here?
```

## nuclei

TBD, if this theory is even valid

## YARA

```
rule CVE-2023-35078
{
strings:
$Regex_URL = /https?:\/\/+([\w\.-]+)(\/+mifs(?:\/+\w+)*\/+api\/+v2\/\w*)(\?*.*)/ nocase

condition:
all of them 
}
```

## Basic regex
```
/https?:\/\/+([\w\.-]+)(\/+mifs(?:\/+\w+)*\/+api\/+v2\/\w*)(\?*.*)/i
```

# Sources

https://forums.ivanti.com/s/article/KB-Remote-unauthenticated-API-access-vulnerability-CVE-2023-35078

https://support.mobileiron.com/ivanti-updates/ivanti-security-update-1.0.0-1.noarch.rpm

https://support.mobileiron.com/httpds/ivanti-update-httpds-2.0.0-1.noarch.rpm

https://doublepulsar.com/mobileirony-backdoor-allows-complete-takeover-of-mobile-security-product-and-endpoints-559733d612e1

https://www.mnemonic.io/resources/blog/ivanti-endpoint-manager-mobile-epmm-authentication-bypass-vulnerability/
